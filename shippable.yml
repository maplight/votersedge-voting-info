language: python  

env:
  - secure: u61YQo0c3R1ks/wbyvptDsh7tZw1IivaGqtFN6KJUc4XkfkCnxDc3TnjaF2MGLtRvL6jx7/yGePPTTyEV856cLUpqwol40eR/PI+AzkbE7/qnOX5HAcmnomfM9drEyFbywsyuaRoYvkNx2o8+Cay+Vsm8nWTOBnIofu+TFnrguHB8DvXGhr7ciWasfkTl0dA7T8rcnFWxx+whkcN/gPHVl/daQTwROJc71eBkOWK6X9dakxheKCzTpIJ7w/BC1mHd5X0nw9WKRKojDs/PjGmiFyiV3WuWqJjTjnu9NbuGorYFD7HpGNclmLvHV+hLsjalfD70QWJN/oD3YtEybFPPA==
  global:
    - AWS_ACCESS_KEY_ID=AKIAIZY5WEKEERJY4OBA
    - AWS_DEFAULT_REGION=us-west-2

build:  

  before_install:
    - pip install awscli                                                

  ci:
    - cd tools/scripts && ./compileJSON.py
    - cd ../../
    #- if [ -n "$(git status --porcelain)" ]; then echo "*** Files have been updated. ***"; git config --global user.email "shane@maplight.org" && git config --global user.name "shaned-maplight" && git add * && git commit -m "latest voter info updates" && git push origin master && aws s3 cp json s3://votersedge-voting-info-static/json --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers --recursive --include "*.*"; else echo "*** Files have not changed. Nothing to commit and upload. ***"; fi
    - if [ -n "$(git status --porcelain)" ]; then 
        echo "*** Files have been updated. ***";
        git add *;
        git commit -m "[skip ci] latest voter info updates";
        ssh-agent bash -c "ssh-add ~/keys/id_${JOB_ID}; git push origin master";
        echo "*** Files committed to git. ***";
      else 
        echo "*** Files have not changed. Nothing to commit and upload. ***";
      fi

  on_success:
    # - aws deploy push --application-name $CD_APP_NAME --s3-location s3://$CD_BUCKET/$CD_KEY --ignore-hidden-files
    # - aws deploy create-deployment --application-name $CD_APP_NAME --s3-location bucket=$CD_BUCKET,key=$CD_KEY,bundleType=zip --deployment-group-name $CD_DEPLOYMENT_GROUP
    - echo "*** Begin uploading to AWS S3 ***";
    - aws s3 cp json s3://votersedge-voting-info-static/json --grants read=uri=http://acs.amazonaws.com/groups/global/AllUsers --recursive --include "*.*";
    - echo "*** Finished uploading to AWS S3 ***";

integrations:
  key:
    - integrationName: PORTLANDIA_SSH_KEY
      type: ssh-key
